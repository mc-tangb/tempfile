<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
	<script type="text/javascript">
	</script>
    <title>宁波智慧消防</title>
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
	<link rel="stylesheet" href="../css/mcMap.css"/>
    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="http://webapi.amap.com/maps?v=1.3&key=de552b55e772415c1ea1617b678504c9&plugin=AMap.MouseTool"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
	<script type="text/javascript" src="../js/jquery-2.0/jquery-2.0.min.js"></script>
	<script type="text/javascript" src="../js/src/AMap.main.js"></script>
    <script type="text/javascript" src="../js/jsonData/json2.js"></script>
	<script type="text/javascript" src="../js/jsonData/mc_region.js"></script>
	<script type="text/javascript" src="../js/jsonData/cities.js"></script>
</head>
<body>
<div id="container"></div>
<div class="draw-poly">
<button id="j_draw_polygon" class="draw-poly-button">开始画多边形</button>
<button id="j_draw_complete" class="draw-poly-button">结束多边形的绘制</button>

</div>
<script>
var map = new AMap.Map('container', {
	resizeEnable: true,
	zoom:15,
	center: [121.607299,29.921007]
});

var drawer = new McMap.DrawMarker(map,data2,{"error":"../images/xiaofs_icon_red.png","correct":"../images/xiaofs_icon_green.png"});
drawer.draw();
drawer.setOffset({'x':-9,'y':-18});
drawer.onclick(function(e){
	
	var data = e.target.getData(),
		point = e.target.getPosition();
	var info = [];
	info.push("<table>");
	var index = 0;
	for(var opt in data){
		if(index%2 == 0){
			info.push("<tr><td>"+opt+":</td><td>"+data[opt]+"</td>");
		}else{
			info.push("<td>"+opt+":</td><td>"+data[opt]+"</td></tr>");
		}
		index ++;
	}
	info.push("</table>");
	var title = '设备状态信息';
	var infoWindow = new AMap.InfoWindow({
		isCustom: true,  //使用自定义窗体
		content: (function(title, content){
			var inf = createInfoWindow(title, content);
			inf.style.width = "480px";
			inf.style.height = "360px";
			return inf;
		}(title, info.join(""))),
		offset: new AMap.Pixel(16, -65)
	});
	infoWindow.open(drawer.getMap(),point);
});

//门楼
var bars = [{
	"id":"1",    //编号
	"address":"",//地址
	"barName":"xxxx", //名称
	"Longitude":"121.610485", //经度
	"Latitude":"29.922723",   //纬度
	"number":100,             //数量
	"alarmNumber":2,          //报警数量
	"type":"烟感",            //类型
}];
//建筑物
var builds = [{
    "id":"1",    //编号
	"barId":"1",  //门楼id
	"address":"",//地址
	"buildingName":"xxxx幢", //名称
	"Longitude":"121.608485", //经度
	"Latitude":"29.919723",   //纬度
	"number":100,             //数量
	"alarmNumber":2,          //报警数量
	"type":"烟感",            //类型
}]
var barMarker = new McMap.DrawMarker(map,bars,{"error":"../images/yangan_icon_red.png","correct":"../images/yangan_icon_green.png"});
barMarker.draw();
barMarker.hide();
barMarker.onclick(function(e){
	var point = e.target.getPosition();
	map.setCenter(point);
	map.setZoom(map.getZoom()+1);
	barMarker.hide();
});
//建筑物marker
var buildingMarker = new McMap.DrawMarker(map,builds,{"error":"../images/yangan_icon_red.png","correct":"../images/yangan_icon_green.png"});
buildingMarker.draw();
buildingMarker.hide();
buildingMarker.onclick(function(e){
	showInfoWindow(null,e,null);
});


//构造弹出框
/*
	type:显示的类型 building,floor,room,device
	e:传入的数据
	point:信息框显示的位置
*/
function showInfoWindow(type,e,lng,lat){//
	if(type === "floor"){ //楼层
		//清理窗口
		//map.clearInfoWindow();
		// 发起请求数据
		var floor = {
			"id":"1", 
			"buildId":"1", //建筑物id
			"barId":"1",   //门楼id
			"floorName":"3楼",   //楼层名称
			"address":"阜通东大街6号院3号楼5楼", //地址
			"number":40,    //数量
			"alarmNumber":1, //报警数量
			"rooms":[{        //房间信息
				"id":"43242342",   //房间id
				"roomName":"xxxx",  //房间名称
				"position":"168,64,170,169",  //房间位置
				"hotspots":"168,64,170,169,411,173,413,63" //在平面图上的热区坐标
			}],
			"type":"烟感", //主体类型
			"mapSrc":"../images/楼层2.jpg" //平面图路径
		}
		// 处理获得的数据
		var content = create_content.create_floor(floor,lng,lat);
		var title = floor["名称"]+'<span style="font-size:11px;color:#F00;">烟感总量:'+floor["数量"]+'，报警数：'+floor["报警数量"]+'</span>';
		var infoWindow = new AMap.InfoWindow({
			isCustom: true,  //使用自定义窗体
			content: createInfoWindow(title, content.join("")),
			offset: new AMap.Pixel(16, -56)
		});
		infoWindow.open(map,new AMap.LngLat(lng,lat));
	}else if(type === "room"){ //房间
		var room = {
			"id":"1",
			"floorId":"1",
			"address":"阜通东大街6号院3号楼5楼505房间",
			"buildId":"1",
			"barId":"1",
			"number":5,
			"alarmNumber":1,
			"type":"烟感",
			"devices":[
				{"id":"1231","name":"xxxx","position":"237,242,325,327","status":"0","hotspots":"237,242,325,327"},
				{"id":"1241","name":"xxxx","position":"429,241,525,330","status":"1","hotspots":"429,241,525,330"}
			],
			"mapSrc":"../images/房间.png"
		};
		var content = create_content.create_room(room,lng,lat);
		var title = '<span style="font-size:11px;color:#F00;">烟感总量:'+room["number"]+'，报警数：'+room["alarmNumber"]+'</span>';
		var infoWindow = new AMap.InfoWindow({
			isCustom: true,  //使用自定义窗体
			content: createInfoWindow(title, content.join("")),
			offset: new AMap.Pixel(16, -56)
		});
		infoWindow.open(map,new AMap.LngLat(lng,lat));
	}else if(type === "device"){ //设备
		
	}else{ //如果type为null,或者空字符串则为建筑物
		var data = e.target.getData(),
			point = e.target.getPosition();
		// 发起请求数据
		var building = {
			"id":"1",
			"barId":"1",
			"name":"xxxxx幢",
			"address":"",
			"floors":[
				{"id":"24343", "name":"xxxl楼","number":"22","alarmNumber":"2"},
				{"id":"4333",  "name":"xxx2楼","number":"22","alarmNumber":"2"},
				{"id":"244543","name":"xxx3楼","number":"22","alarmNumber":"2"},
				{"id":"2543",  "name":"xxx4楼","number":"22","alarmNumber":"2"},
			],
			"number":100,
			"alarmNumber":2,
			"type":"烟感",
			"hotspots":""	
		};
		// 处理获得的数据
		var content = create_content.create_building(building,point.lng,point.lat);
		var title = building["name"]+'<span style="font-size:11px;color:#F00;">烟感总量:'+building["number"]+'，报警数：'+building["alarmNumber"]+'</span>';
		var infoWindow = new AMap.InfoWindow({
			isCustom: true,  //使用自定义窗体
			content: createInfoWindow(title, content.join("")),
			offset: new AMap.Pixel(16, -56)
		});
		infoWindow.open(e.target.getMap(),point);
	}
		
}
//构造信息框内容
var create_content = {
	/*构造建筑物*/
	create_building:function(building,lng,lat){
		var content = [];
		content.push("<p>地址："+building["address"]+"</p>");
		content.push("<p>楼层分布：</p>");
		var strImgMap = "<div style='margin-top:2px;border:1px solid #CCCCCC;width:100%;height:403px;'>"+
			"<ul class='floor-ui'>";
		for(var i=0;i<building["floors"].length;i++){
			strImgMap += "<li><span onclick='javascript:showInfoWindow(\"floor\","+building["floors"][i]["id"]+","+lng+","+lat+")'>"+building["floors"][i]["name"]+"：</span>烟感总量:"+building["floors"][i]["number"]+"，报警数："+building["floors"][i]["alarmNumber"]+"</li>"
		}
		strImgMap += "</ul></div>"
		content.push(strImgMap);
		return content;
	},
	/*
		构造楼层
	*/
	create_floor:function(floor,lng,lat){
		var content = [];
		content.push("<p>地址："+floor["address"]+"</p>");
		var strImgMap = "<img src='"+floor["mapSrc"]+"' width='560' height='393' border='0' usemap='#MapFloor'>"+
			"<map name='MapFloor' id='MapFloor'>";
		for(var i=0;i<floor["rooms"].length;i++){
			strImgMap += "<area shape='poly' coords='"+floor["rooms"][i]["hotspots"]+"' href='javascript:showInfoWindow(\"room\","+floor["rooms"][i]["id"]+","+lng+","+lat+")' />"
		}
		strImgMap += "</map>";
		content.push(strImgMap);
		return content;
	},
	/*构造房间信息*/
	create_room:function(room,lng,lat){
		content = [];
		content.push("<p>地址："+room["address"]+"</p>");
		var strImgMap = "<div class='roomLeftDiv'>"+
		    "<ul >";
			for(var i=0;i<room["devices"].length;i++){
				strImgMap += "<li>"+room["devices"][i]["name"]+"："+room["devices"][i]["status"]+"</li>"
			}
			strImgMap += "</ul>";
			strImgMap += "</div><div class='roomRightDiv'>"+
		    "<img src='"+room["mapSrc"]+"' style='margin-top:13px;' width='100%' height='393' border='0' usemap='#MapRoom'>"+
			"<map name='MapRoom' id='MapRoom'>";
			for(var i=0;i<room["devices"].length;i++){
				strImgMap += "<area shape='rect' coords='"+room["devices"][i]["hotspots"]+"' href='#' />";
			}
			strImgMap += "</map></div>";
		content.push(strImgMap);
		return content;
	}
};
//画区域
var plys = new McMap.DrawPolygon(map,area,{
		strokeColor: "#FF33FF", //线颜色
        strokeOpacity: 0.2, //线透明度
        strokeWeight: 3,    //线宽
        fillColor: "#5891fc", //填充色
        fillOpacity: 0.35//填充透明度
});
plys.draw();
plys.onmouseover(function(e){
	var target = e.target;
	target.setOptions({
		strokeColor: "#FF33FF", //线颜色
        strokeOpacity: 0.2, //线透明度
        strokeWeight: 3,    //线宽
        fillColor: "#red", //填充色
        fillOpacity: 0.35//填充透明度
	});
});
plys.onmouseout(function(e){
	var target = e.target;
	target.setOptions({
		strokeColor: "#FF33FF", //线颜色
        strokeOpacity: 0.2, //线透明度
        strokeWeight: 3,    //线宽
        fillColor: "#5891fc", //填充色
        fillOpacity: 0.35//填充透明度
	});
});
map.on("zoomend",function(e){
	var zoom = map.getZoom();
	var labels = plys.getLabel();
	labels.forEach(function(label){
		if(zoom<15){
			label.hide();
		}else{
			label.show();
		}
	});
	if(zoom<16){
		barMarker.show();
		buildingMarker.hide();
	}else{
		barMarker.hide();
		buildingMarker.show();
	}
})
//构建自定义信息窗体
function createInfoWindow(title, content) {
	var info = document.createElement("div");
	info.className = "info";

	//可以通过下面的方式修改自定义窗体的宽高
	//info.style.width = "400px";
	// 定义顶部标题
	info.style.width = "580px";
	info.style.height = "472px";
	var top = document.createElement("div");
	var titleD = document.createElement("div");
	var closeX = document.createElement("img");
	top.className = "info-top";
	titleD.innerHTML = title;
	closeX.src = "http://webapi.amap.com/images/close2.gif";
	closeX.onclick = closeInfoWindow;

	top.appendChild(titleD);
	top.appendChild(closeX);
	info.appendChild(top);

	// 定义中部内容
	var middle = document.createElement("div");
	middle.className = "info-middle";
	middle.style.backgroundColor = 'white';
	middle.innerHTML = content;
	info.appendChild(middle);

	// 定义底部内容
	var bottom = document.createElement("div");
	bottom.className = "info-bottom";
	bottom.style.position = 'relative';
	bottom.style.top = '0px';
	bottom.style.margin = '0 auto';
	var sharp = document.createElement("img");
	sharp.src = "http://webapi.amap.com/images/sharp.png";
	bottom.appendChild(sharp);
	info.appendChild(bottom);
	
	return info;
}

//关闭信息窗体
function closeInfoWindow() {
	map.clearInfoWindow();
}
//画多边形

var startBut = document.getElementById("j_draw_polygon");
var closeBut = document.getElementById("j_draw_complete");
var mcTools = new McMap.DrawPolygonHand(map);
var drawPolygonStart = AMap.event.addDomListener(startBut,"click",function(e){
	mcTools.start({strokeColor: "#FF33FF", //线颜色
		strokeOpacity: 0.2, //线透明度
		strokeWeight: 3,    //线宽
		fillColor: "#5891fc", //填充色
		fillOpacity: 0.35//填充透明度
	});
});
var drawPolygonEnd = AMap.event.addDomListener(closeBut,"click",function(e){
	mcTools.end();
	var obj = mcTools.getObj();
	console.log(obj)
});
//编辑多边形
$(document).on("contextmenu",document,function(){return false});
plys.onrightclick(function(e){
	$("#j_editply_menu").empty().remove();
	var pixel = e.pixel;
	var target = e.target;
	createMenu(pixel);
	var polygonEditer = new McMap.EditPolygon(map,target);
	$(document).off("click","#j_open_editply_menu");
	$(document).on("click","#j_open_editply_menu",function(){
		polygonEditer.start();
		$("#j_editply_menu").remove();
	})
	$(document).on("click","#j_close_editply_menu",function(){
		polygonEditer.end();
		var obj = polygonEditer.getObj();
		$("#j_editply_menu").remove();
	})
});

$(document).on("contextmenu",document,function(){return false}); //取消浏览器默认的右击事件
function createMenu(pixel){
	var oul = document.createElement("ul");
	oul.setAttribute("id","j_editply_menu");
	oul.style.position = "absolute";
	oul.style.left = pixel.x+"px";
	oul.style.top = pixel.y+"px";
	oul.style.listStyle = "none";
	oul.style.margin = "0px";
	oul.style.padding = "0px";
	oul.style.background = "rgb(89, 224, 156)" ;
	var oliopen = document.createElement("li");
	oliopen.setAttribute("id","j_open_editply_menu");
	oliopen.style.color = '#905353';
	oliopen.style.cursor = 'pointer';
	oliopen.style.fontFamily = "楷体";
	oliopen.style.borderBottom = '1px solid #708090';
	oliopen.style.width = '34px';
	oliopen.style.height = '36px';
	oliopen.innerHTML = "开始编辑";
	oul.appendChild(oliopen);
	var oliclose = document.createElement("li");
	oliclose.setAttribute("id","j_close_editply_menu");
	oliclose.style.color = '#905353';
	oliclose.style.cursor = 'pointer';
	oliclose.style.fontFamily = "楷体";
	oliclose.style.borderBottom = '1px solid #708090';
	oliclose.style.width = '34px';
	oliclose.style.height = '36px';
	oliclose.innerHTML = "完成编辑";
	oul.appendChild(oliclose);
	document.getElementsByTagName("body")[0].appendChild(oul);
}

for(var i=0;i<citys.length;i++){
	if(i%2)citys[i].status  = 0;
}
//var bdmarker = new McMap.BdMarker(map,citys,{"error":"../images/yangan_icon_red.png","correct":"../images/yangan_icon_green.png"});
//bdmarker.draw();
//map.setFeatures(['bg','road','building']);//['bg','road','building','point']
//console.log(map.getFeatures());

var result = new McMap.SearchCircle(map,drawer.getMarkers(),new AMap.LngLat(121.115056367676,28.4110091485596),{
				strokeColor: "#F33", //线颜色
				strokeOpacity: 1, //线透明度
				strokeWeight: 3, //线粗细度
				fillColor: "#ee2200", //填充颜色
				fillOpacity: 0.35//填充透明度
			},{'low':1000,'top':5000});
result.showContainsMarkers();
</script>
</body>
</html>